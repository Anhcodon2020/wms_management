{% extends "base.html" %}
{% block content %}
<h2>BBR Report</h2>

<div class="card mb-4">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <label class="form-label">Import CSV (Logic t√πy ch·ªânh)</label>
            <div class="input-group">
                <input type="file" name="file" class="form-control" accept=".csv" required>
                <button class="btn btn-success" type="submit">üöÄ X·ª≠ l√Ω & Upload</button>
            </div>
        </form>
        <div class="progress mt-3 d-none" id="progressContainer" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
        </div>
    </div>
</div>

<div class="d-flex gap-2 mb-3">
    <form method="GET" class="flex-grow-1">
        <div class="input-group">
        <select name="week" class="form-select" style="max-width: 150px;" onchange="this.form.submit()">
            <option value="">-- T·∫•t c·∫£ tu·∫ßn --</option>
            {% for w in weeks %}
            <option value="{{ w }}" {% if selected_week|string == w|string %}selected{% endif %}>Tu·∫ßn {{ w }}</option>
            {% endfor %}
        </select>
        <input type="text" name="q" class="form-control" placeholder="üîç T√¨m ki·∫øm trong b√°o c√°o..." value="{{ request.args.get('q', '') }}">
        <button class="btn btn-outline-secondary" type="submit">T√¨m ki·∫øm</button>
        </div>
    </form>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#poStatsModal">üìä Th·ªëng k√™ PO</button>
    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteWeekModal">üóëÔ∏è X√≥a tu·∫ßn</button>
</div>

<div class="alert alert-info">üìä T·ªïng CBM: {{ "%.3f"|format(total_cbm) }} m¬≥</div>

<div class="row mb-3 text-center g-3">
    <div class="col">
        <div class="card h-100">
            <div class="card-header">Pallet 1m2 (Quy ƒë·ªïi)</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(pallet_stats['1m2']) }} m¬≥</h5>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-header">Pallet 1m6 (Quy ƒë·ªïi)</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(pallet_stats['1m6']) }} m¬≥</h5>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-header">Pallet 1m9 (Quy ƒë·ªïi)</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(pallet_stats['1m9']) }} m¬≥</h5>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100">
            <div class="card-header">Pallet 1.5</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(pallet_stats['1.5']) }} m¬≥</h5>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3 text-center g-3">
    <div class="col">
        <div class="card h-100 border-info">
            <div class="card-header bg-info text-white">Chipboard 1210</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(chipboard_stats['1210']) }} m¬≥</h5>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-info">
            <div class="card-header bg-info text-white">Chipboard 1610</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(chipboard_stats['1610']) }} m¬≥</h5>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-info">
            <div class="card-header bg-info text-white">Chipboard 1910</div>
            <div class="card-body">
                <h5 class="card-title">{{ "%.3f"|format(chipboard_stats['1910']) }} m¬≥</h5>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive" style="max-height: 600px;">
    <table class="table table-sm table-striped">
        <thead>
            <tr>
                  <th>Week</th>
                <th>
                    <a href="{{ url_for('bbr', sort_by='deliverydate', order='desc' if sort_by=='deliverydate' and order=='asc' else 'asc', q=request.args.get('q', ''), week=selected_week) }}" class="text-dark text-decoration-none">
                        Delivery Date {{ '‚¨ÜÔ∏è' if sort_by=='deliverydate' and order=='asc' else ('‚¨áÔ∏è' if sort_by=='deliverydate' and order=='desc' else '') }}
                    </a>
                </th>
              
                <th>Supplier</th>
                <th>
                    <a href="{{ url_for('bbr', sort_by='parentpo', order='desc' if sort_by=='parentpo' and order=='asc' else 'asc', q=request.args.get('q', ''), week=selected_week) }}" class="text-dark text-decoration-none">
                        PO {{ '‚¨ÜÔ∏è' if sort_by=='parentpo' and order=='asc' else ('‚¨áÔ∏è' if sort_by=='parentpo' and order=='desc' else '') }}
                    </a>
                </th>
                <th>Item</th>
                <th>Qty</th>
                            
                <th>Total CBM</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr><td>{{ row.week }}</td><td>{{ row.deliverydate }}</td><td>{{ row.TENNCC }}</td><td>{{ row.parentpo }}</td><td>{{ row.item }}</td><td>{{ row.qty }}</td><td>{{ "%.3f"|format(row.total_cbm or 0) }}</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bbr', page=page-1, q=request.args.get('q', ''), week=selected_week, sort_by=sort_by, order=order) }}">Tr∆∞·ªõc</a>
        </li>
        <li class="page-item disabled"><span class="page-link">Trang {{ page }} / {{ total_pages }}</span></li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('bbr', page=page+1, q=request.args.get('q', ''), week=selected_week, sort_by=sort_by, order=order) }}">Sau</a>
        </li>
    </ul>
</nav>
{% endif %}

<!-- Modal X√≥a Tu·∫ßn -->
<div class="modal fade" id="deleteWeekModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">‚ö†Ô∏è X√≥a d·ªØ li·ªáu theo tu·∫ßn</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('delete_bbr_week') }}" method="POST">
                <div class="modal-body">
                    <p>Ch·ªçn tu·∫ßn b·∫°n mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu:</p>
                    <select name="week_to_delete" class="form-select" required>
                        <option value="">-- Ch·ªçn tu·∫ßn --</option>
                        {% for w in weeks %}
                        <option value="{{ w }}">Tu·∫ßn {{ w }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-danger mt-3 small"><strong>L∆∞u √Ω:</strong> H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy b·ªè</button>
                    <button type="submit" class="btn btn-danger">X√≥a ngay</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Th·ªëng k√™ PO -->
<div class="modal fade" id="poStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">üìä Th·ªëng k√™ theo Parent PO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Parent PO</th>
                            <th>Supplier</th>
                            <th class="text-end">T·ªïng S·ªë Ki·ªán (Carton)</th>
                            <th class="text-end">T·ªïng CBM</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in po_stats %}
                        <tr>
                            <td>{{ row.parentpo }}</td>
                            <td>{{ row.TENNCC }}</td>
                            <td class="text-end">{{ "{:,.0f}".format(row.qty) }}</td>
                            <td class="text-end">{{ "%.3f"|format(row.total_cbm) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('export_po_stats', week=request.args.get('week', ''), q=request.args.get('q', '')) }}" class="btn btn-success">üì• Xu·∫•t Excel</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const form = document.querySelector('form[enctype="multipart/form-data"]');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Ch·∫∑n reload trang
            
            const formData = new FormData(form);
            const xhr = new XMLHttpRequest();
            
            progressContainer.classList.remove('d-none'); // Hi·ªán thanh progress
            
            xhr.open('POST', window.location.href, true);
            
            // S·ª± ki·ªán theo d√µi ti·∫øn tr√¨nh upload
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    progressBar.innerText = Math.round(percentComplete) + '%';
                    
                    if (percentComplete === 100) {
                        progressBar.innerText = "ƒêang x·ª≠ l√Ω d·ªØ li·ªáu... Vui l√≤ng ƒë·ª£i!";
                        progressBar.classList.add('bg-success'); // ƒê·ªïi m√†u xanh khi upload xong
                    }
                }
            };
            
            // Khi ho√†n t·∫•t (Server tr·∫£ v·ªÅ k·∫øt qu·∫£)
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Thay th·∫ø n·ªôi dung trang hi·ªán t·∫°i b·∫±ng trang k·∫øt qu·∫£ (ch·ª©a th√¥ng b√°o Flash)
                    document.open();
                    document.write(xhr.responseText);
                    document.close();
                } else {
                    alert('C√≥ l·ªói x·∫£y ra: ' + xhr.statusText);
                    progressContainer.classList.add('d-none');
                }
            };
            
            xhr.onerror = function() {
                alert('L·ªói k·∫øt n·ªëi m·∫°ng!');
                progressContainer.classList.add('d-none');
            };
            
            xhr.send(formData);
        });
    }

    // Bi·ªÉu ƒë·ªì tr√≤n (Pie Chart)
    const ctx = document.getElementById('palletChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Pallet 1m2', 'Pallet 1m6', 'Pallet 1m9', 'Pallet 1.5'],
                datasets: [{
                    data: [
                        {{ pallet_stats['1m2'] }},
                        {{ pallet_stats['1m6'] }},
                        {{ pallet_stats['1m9'] }},
                        {{ pallet_stats['1.5'] }}
                    ],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
</script>
{% endblock %}